# thead_local

线程局部存储（TLS）是一种让每个线程拥有独立变量副本的存储机制 —— 变量不会在多个线程间共享，每个线程对变量的读写仅操作自己的专属副本，无需额外加锁，
长用于存储线程私有状态。

C++11 引入 ```thread_local``` 关键字，实现跨平台的标准用法。

## 基本语法

1. 修饰全局变量

```C++
thread_local int th_id;
```

2. 修饰静态变量

```C++
// （1）全局静态变量
static thread_local int g_thread_id;
// （2）类静态成员变量
class Logger {
public:
    static thread_local std::string s_lof_prefix;
};
// （3）局部静态变量（函数内）
void func() {
    static thread_local int s_call_count = 0;
}
```

## 核心特性

1. 生命周期

（1）线程创建时变量初始化；

（2）线程退出时变量销毁（无论变量是全局/局部静态）；

2. 初始化时机

（1）全局/类静态 ```thread_local``` 变量：线程首次访问时初始化（懒初始化），或在线程启动时主动初始化（依赖编译器）；

（2）局部静态```thread_local``` 变量：线程首次进入函数时初始化（仅一次）；

## 与平台特定 TLS 对比

特性              C++11 thread_local    Linux __thread    windows _declspec(thread)

跨平台性          是（标准）                否（GCC/Clang）      否（MSVC）

支持类型          所以类型（POD/非POD）      仅 POD 类型        POD + 部分非 POD 类型

类静态成员        支持                        支持                支持

局部静态变量      支持                        支持                支持

动态链接库兼容性  好                          一般                差






